<html>

<head>
  <meta name="apple-mobile-web-app-capable" content="yes">
  <!-- A-Frame itself -->
  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
  <style>
    /* Token title/description styling variables - edit these to change token text appearance */
    :root {
      --token-title-size: 40px;
      --token-title-color: #ffffff;
      --token-desc-size: 30px;
      --token-desc-color: #d5d75f;
    }
    p.Description {
      position: fixed;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 20px;
      color: rgb(255, 255, 255);
      background-color: rgba(0, 0, 0, 0.189);
      padding: 10px;
      border-radius: 5px;
      z-index: 1000;
      width: 80%;
      max-height: 200px;
      overflow-y: auto;
      word-wrap: break-word;

    }

    /* Specific classes for token text so they can have independent styles */
    .TokenTitleText {
      font-size: var(--token-title-size);
      color: var(--token-title-color);
      text-align: center;
    }

    .TokenDescriptionText {
      font-size: var(--token-desc-size);
      color: var(--token-desc-color);
      text-align: center;
    }

    p.Title {
      position: fixed;
      top: 10px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 30px;
      color: rgb(255, 255, 255);
      background-color: rgba(0, 0, 0, 0.189);
      padding: 10px;
      border-radius: 5px;
      z-index: 1000;
      font-weight: bold;
      width: 80%;
      text-align: center;
    }

    .overlay-image {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 95%;
      max-width: 800px;
      z-index: 2000;
      display: none;
    }

    .token-image {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 95%;
      max-width: 800px;
      z-index: 2000;
      display: none;
    }

    .photo-overlay {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 95%;
      max-width: 800px;
      z-index: 2000;
      display: none;
    }

    .video-overlay {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 100%;
      max-width: 800px;
      z-index: 2000;
      display: none;
    }
  </style>
</head>

<body style="margin: 0px; overflow: hidden">

  <img id="congratsOverlay" class="overlay-image" src="./Assets/Token/Token02.png">
  <img id="tokenOverlay" class="token-image" src="./Assets/Token/Token01.png">
  <!-- Sound assets for tokens/overlays -->
  <audio id="SoundToken01" src="./Assets/Voices/SoundToken01.wav" preload="auto"></audio>
  <audio id="SoundToken02" src="./Assets/Voices/SoundToken02.wav" preload="auto"></audio>
  <img id="riverheadOverlay" class="photo-overlay" src="./Assets/LandscapePhoto/Riverhead.png">
  <img id="bullringOverlay" class="photo-overlay" src="./Assets/LandscapePhoto/BullRingUrchins.png">

  <!-- Token titles and descriptions (editable directly) -->
  <p id="TokenTitleSuffragette" class="Title TokenTitleText" style="display:none">Suffragette Token Title</p>
  <p id="TokenDescriptionSuffragette" class="Description TokenDescriptionText" style="display:none">Suffragette token description.</p>

  <p id="TokenTitleSweep" class="Title TokenTitleText" style="display:none">Sweep Token Title</p>
  <p id="TokenDescriptionSweep" class="Description TokenDescriptionText" style="display:none">Sweep token description.</p>

  <p id="TokenTitleLongshipArrival" class="Title TokenTitleText" style="display:none">Longship Arrival Token Title</p>
  <p id="TokenDescriptionLongshipArrival" class="Description TokenDescriptionText" style="display:none">Longship Arrival token description.</p>

  <p id="TokenTitleWhiteGift" class="Title TokenTitleText" style="display:none">White Gift Token Title</p>
  <p id="TokenDescriptionWhiteGift" class="Description TokenDescriptionText" style="display:none">White Gift token description.</p>

  <p id="TokenTitleEdwardWatkins" class="Title TokenTitleText" style="display:none">Edward Watkins Token Title</p>
  <p id="TokenDescriptionEdwardWatkins" class="Description TokenDescriptionText" style="display:none">Edward Watkins token description.</p>

  <video id="sweepMainVideo" class="video-overlay" src="./Assets/CharactersAnimations/01 Sweep/SweepMain.webm"
    preload="auto" playsinline>

  </video>
  <video id="suffragetteMainVideo" class="video-overlay"
    src="./Assets/CharactersAnimations/02 Suffragette/SuffragetteMain.webm" preload="auto" playsinline>
  </video>

  <video id="longshipArrivalMainVideo" class="video-overlay"
    src="./Assets/CharactersAnimations/04 LongshipArrival/LongshipArrivalMain.webm" preload="auto" playsinline>
  </video>

  <video id="vikingEndMainVideo" class="video-overlay"
    src="./Assets/CharactersAnimations/05 VikingEnd/VikingEndMain.webm" preload="auto" playsinline>
  </video>

  <video id="WhiteGiftVideo" class="video-overlay" src="./Assets/CharactersAnimations/08 WhiteGift/WhitGiftMain.webm"
    preload="auto" playsinline>
  </video>

  <video id="EdwardWatkinsVideo" class="video-overlay"
    src="./Assets/CharactersAnimations/09 EdwardWatkins/EdwardWatkinsMain.webm" preload="auto" playsinline>
  </video>

  <video id="longshipTextVideo" class="video-overlay"
    src="./Assets/CharactersAnimations/03 LongshipText/LongshipTextMain.webm" preload="auto" playsinline>
  </video>

      <a-scene embedded arjs
        renderer="antialias: true; logarithmicDepthBuffer: true; colorManagement: true; sortObjects: true;">
        <!-- <a-marker preset="hiro" smooth="true"> -->

        <!-- <a-assets> -->

        <!-- </a-assets> -->

        <a-marker smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5" id="character01M"
          type="pattern" url="./Assets/Markers/character01M.patt">

        </a-marker>

        <a-marker smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5" id="SuffragetteM"
          type="pattern" url="./Assets/Markers/02 Suffragette Marker/SuffragetteM.patt">

        </a-marker>

        <a-marker smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5" id="LongshipArrivalM"
          type="pattern" url="./Assets/Markers/04 LongshipArrival Marker/LongshipArrivalM.patt">

        </a-marker>

        <a-marker smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5" id="VikingEndM"
          type="pattern" url="./Assets/Markers/05%20VikingEnd%20Marker/VikingEndM.patt">

        </a-marker>

        <a-marker smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5" id="RiverheadM"
          type="pattern" url="./Assets/Markers/06 Riverhead Marker/RiverheadM.patt">

        </a-marker>

        <a-marker smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5" id="BullRingM"
          type="pattern" url="./Assets/Markers/07 BullRing Marker/BullRingM.patt">

        </a-marker>

        <a-marker smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5" id="LongshipTextM"
          type="pattern" url="./Assets/Markers/03 LongshipText Marker/LongshipArrivalTextM.patt">

        </a-marker>

        <a-marker smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5" id="WhiteGiftM"
          type="pattern" url="./Assets/Markers/08 WhiteGift Marker/WhiteGiftM.patt">

        </a-marker>

        <a-marker smooth="true" smoothCount="10" smoothTolerance="0.01" smoothThreshold="5" id="EdwardWatkinsM"
          type="pattern" url="./Assets/Markers/09 EdwardWatkins Marker/EdwardWatkinsM.patt">

        </a-marker>

        <a-entity camera>
        </a-entity>
      </a-scene>


      <script>

        let titleElement = null;
        let descriptionElement = null;
        let currentlyPlayingEntity = null;
        let allMarkersDetected = false;
        let overlayTimer = null;
        let lastDetectedMarker = null;
        let tokenShown = false; // Track if token has been shown
        let soundPlayed = false; // Track if sound has been played
        let videoStarted = false; // Track if video has been started

        // Add these variables at the top of your script section
        let currentPlayingVideo = null;
        const videoStates = {
          'sweepMainVideo': { played: false, completed: false },
          'suffragetteMainVideo': { played: false, completed: false },
          'longshipArrivalMainVideo': { played: false, completed: false },
          'vikingEndMainVideo': { played: false, completed: false },
          'longshipTextVideo': { played: false, completed: false },
          'WhiteGiftVideo': { played: false, completed: false },
          'EdwardWatkinsVideo': { played: false, completed: false }
        };

        const tokenStates = {
          'sweepMainVideo': { shown: false },
          'suffragetteMainVideo': { shown: false },
          'longshipArrivalMainVideo': { shown: false },
          'WhiteGiftVideo': { shown: false },
          'EdwardWatkinsVideo': { shown: false }
        };

        // Add this variable at the top of your script section
        let markersDisabled = false;
        // When an overlay-image is shown and should remain on screen forever
        let overlayImagePersistent = false;

        // Helper to show overlay-image elements persistently and disable markers
        function showOverlayImagePersistent(id) {
          const el = document.getElementById(id);
          if (!el) return;
          el.style.display = 'block';
          // Play SoundToken02 (if available)
          const audio2 = document.getElementById('SoundToken02');
          if (audio2 && typeof audio2.play === 'function') {
            try { audio2.currentTime = 0; } catch (e) {}
            audio2.play().catch(err => console.warn('SoundToken02 play error', err));
          }
          overlayImagePersistent = true;
          // disable markers so camera won't recognize them anymore
          disableAllMarkers();
        }

        // Add this function to disable all markers
        function disableAllMarkers() {
          const markers = document.querySelectorAll('a-marker');
          markers.forEach(marker => {
            marker.setAttribute('visible', 'false');
            marker.removeAttribute('emitevents');
          });
          markersDisabled = true;
        }

  function showTokenAndPlaySound(markerId, videoID) {
          // const videoId = markerId === 'character01M' ? 'sweepMainVideo' :
          //   markerId === 'SuffragetteM' ? 'suffragetteMainVideo' :
          //     'longshipArrivalMainVideo';

          // The function now expects (markerId, videoID)
          // If videoID corresponds to an ordinary token, show token overlay + titles/descriptions
          // Otherwise, for Viking end show congrats overlay
          // If videoID corresponds to an ordinary token, show token overlay + titles/descriptions
          // Otherwise, for Viking end show congrats overlay
          if (markerId !== "VikingEndM") {
            const tokenOverlay = document.getElementById('tokenOverlay');
            tokenOverlay.style.display = 'block';

            // If a marker Title/Description (titleElement/descriptionElement) is present, hide them temporarily
            // Store references globally so markerLost can restore them immediately
            if (titleElement) {
              window._previousMarkerTitle = titleElement;
              titleElement.style.display = 'none';
            } else {
              window._previousMarkerTitle = null;
            }
            if (descriptionElement) {
              window._previousMarkerDescription = descriptionElement;
              descriptionElement.style.display = 'none';
            } else {
              window._previousMarkerDescription = null;
            }

            // Play SoundToken01 (if present) using the <audio> element
            const audio1 = document.getElementById('SoundToken01');
            if (audio1 && typeof audio1.play === 'function') {
              try { audio1.currentTime = 0; } catch (e) {}
              audio1.play().catch(err => console.warn('SoundToken01 play error', err));
            }

            // Map videoID to suffix used in TokenTitle/TokenDescription IDs
            const suffixMap = {
              'suffragetteMainVideo': 'Suffragette',
              'sweepMainVideo': 'Sweep',
              'longshipArrivalMainVideo': 'LongshipArrival',
              'WhiteGiftVideo': 'WhiteGift',
              'EdwardWatkinsVideo': 'EdwardWatkins'
            };

            const suffix = suffixMap[videoID] || '';
            const titleEl = suffix ? document.getElementById('TokenTitle' + suffix) : null;
            const descEl = suffix ? document.getElementById('TokenDescription' + suffix) : null;

            if (titleEl) titleEl.style.display = 'block';
            if (descEl) descEl.style.display = 'block';

            // Hide token and texts after 5 seconds and restore previous title/description if any
            const tokenHideTimer = setTimeout(() => {
              tokenOverlay.style.display = 'none';
              if (titleEl) titleEl.style.display = 'none';
              if (descEl) descEl.style.display = 'none';

              // Restore previous marker Title/Description if they existed
              if (window._previousMarkerTitle) window._previousMarkerTitle.style.display = 'block';
              if (window._previousMarkerDescription) window._previousMarkerDescription.style.display = 'block';
              // clear stored references
              window._previousMarkerTitle = null;
              window._previousMarkerDescription = null;
            }, 5000);

            if (videoID && tokenStates[videoID]) tokenStates[videoID].shown = true;
            // store timer on tokenStates so markerLost can clear it and restore UI immediately
            if (videoID) tokenStates[videoID].hideTimer = tokenHideTimer;
          } else {
            // Show congrats overlay persistently and disable markers
            showOverlayImagePersistent('congratsOverlay');
          }

        }

        // Add token title/description elements (editable directly in HTML)
        // These are hidden by default and will be shown when the token overlay appears
        function addTokenTextPlaceholders() {
          const mappings = [
            { idTitle: 'TokenTitleSuffragette', idDesc: 'TokenDescriptionSuffragette', title: 'Suffragette Token Title', desc: 'Suffragette token description.' },
            { idTitle: 'TokenTitleSweep', idDesc: 'TokenDescriptionSweep', title: 'Sweep Token Title', desc: 'Sweep token description.' },
            { idTitle: 'TokenTitleLongshipArrival', idDesc: 'TokenDescriptionLongshipArrival', title: 'Longship Arrival Token Title', desc: 'Longship Arrival token description.' },
            { idTitle: 'TokenTitleWhiteGift', idDesc: 'TokenDescriptionWhiteGift', title: 'White Gift Token Title', desc: 'White Gift token description.' },
            { idTitle: 'TokenTitleEdwardWatkins', idDesc: 'TokenDescriptionEdwardWatkins', title: 'Edward Watkins Token Title', desc: 'Edward Watkins token description.' }
          ];

          mappings.forEach(m => {
            // Title
            if (!document.getElementById(m.idTitle)) {
              const t = document.createElement('p');
              t.id = m.idTitle;
              t.className = 'Title TokenTitleText';
              t.textContent = m.title; // user can edit this directly in the HTML later
              t.style.display = 'none';
              document.body.appendChild(t);
            }

            // Description
            if (!document.getElementById(m.idDesc)) {
              const d = document.createElement('p');
              d.id = m.idDesc;
              d.className = 'Description TokenDescriptionText';
              d.textContent = m.desc; // user can edit this directly in the HTML later
              d.style.display = 'none';
              document.body.appendChild(d);
            }
          });
        }

        function setupMarker(markerId, titleText, descriptionText, videoID) {
          const marker = document.querySelector(`#${markerId}`);
          const video = document.querySelector(`#${videoID}`);

          document.addEventListener("DOMContentLoaded", () => {
            const video = document.querySelector(`#${videoID}`);
            video.pause(); // make sure it doesn't run
          });
          // Add ended event listener to track completion
          video.addEventListener('ended', () => {
            videoStates[videoID].completed = true;
            const overlay = document.getElementById(`${videoID}`);
            overlay.style.display = 'none';

            // Only show token for specific videos

            // Ensure token text placeholders exist
            addTokenTextPlaceholders();

            showTokenAndPlaySound(markerId, videoID);

          });

          marker.addEventListener('markerFound', () => {

            console.log(`Marker ${markerId} found`);

            if (markersDisabled) return; // Skip if markers are disabled

            // Special handling for vikingEndMainVideo
            if (videoID === 'vikingEndMainVideo') {

              disableAllMarkers();
            }

            if (!titleElement && !descriptionElement) {
              titleElement = document.createElement('p');
              titleElement.className = "Title";
              titleElement.textContent = titleText;
              document.body.appendChild(titleElement);

              descriptionElement = document.createElement('p');
              descriptionElement.className = "Description";
              descriptionElement.textContent = descriptionText;
              document.body.appendChild(descriptionElement);
              
              // Handle video playback
              if (!videoStates[videoID].completed) {
                // Stop current playing video if any
                if (currentPlayingVideo && currentPlayingVideo !== video) {
                  const overlay = document.getElementById(`${currentPlayingVideo.id}`);
                  overlay.style.display = 'none';
                  currentPlayingVideo.pause();
                  console.log(`Paused video: ${currentPlayingVideo.id}`);
                }

                // Play new video
                // if (video.paused) {
              
                  video.play();
                  const overlay = document.getElementById(`${videoID}`);
                  overlay.style.display = 'block';
                // }
    
                currentPlayingVideo = video;
                videoStates[videoID].played = true;
              }
            }
          });

          marker.addEventListener('markerLost', () => {

            if (titleElement && descriptionElement) {
              titleElement.remove();
              descriptionElement.remove();
              titleElement = null;
              descriptionElement = null;
            }
            // Hide any token overlays/texts when marker lost
            const tokenOverlay = document.getElementById('tokenOverlay');
            if (tokenOverlay) tokenOverlay.style.display = 'none';
            const congrats = document.getElementById('congratsOverlay');
            // Do not hide persistent overlay-images
            if (congrats && !overlayImagePersistent) congrats.style.display = 'none';

            // Clear any pending hide timers for tokens and reset tokenStates
            Object.keys(tokenStates).forEach(k => {
              if (tokenStates[k].hideTimer) {
                clearTimeout(tokenStates[k].hideTimer);
                delete tokenStates[k].hideTimer;
              }
              tokenStates[k].shown = false;
            });

            // Hide all TokenTitle/Description elements if present
            ['Suffragette','Sweep','LongshipArrival','WhiteGift','EdwardWatkins'].forEach(suffix => {
              const t = document.getElementById('TokenTitle' + suffix);
              const d = document.getElementById('TokenDescription' + suffix);
              if (t) t.style.display = 'none';
              if (d) d.style.display = 'none';
            });

            // Restore any previously hidden marker Title/Description immediately
            if (window._previousMarkerTitle) {
              window._previousMarkerTitle.style.display = 'block';
              window._previousMarkerTitle = null;
            }
            if (window._previousMarkerDescription) {
              window._previousMarkerDescription.style.display = 'block';
              window._previousMarkerDescription = null;
            }
          });
        }

        // Setup markers with their respective titles and descriptions
        setupMarker(
          'character01M',
          "Sweep", // Title - replace with your desired title
          "", // Description - replace with your desired description
          'sweepMainVideo'
        );

        setupMarker(
          'SuffragetteM',
          "Suffragette",
          "",
          'suffragetteMainVideo'
        );

        setupMarker(
          'LongshipArrivalM',
          "Longship Arrival",
          "",
          'longshipArrivalMainVideo'
        );

        setupMarker(
          'VikingEndM',
          "Viking End",
          "",
          'vikingEndMainVideo'
        );

        setupMarker(
          'WhiteGiftM',
          "WhiteGift",
          "",
          'WhiteGiftVideo'
        );

        setupMarker(
          'EdwardWatkinsM',
          "Edward Watkins",
          "",
          'EdwardWatkinsVideo'
        );

        // Replace the RiverheadM and BullRingM setupMarker calls with this custom setup
  const riverheadMarker = document.querySelector('#RiverheadM');
        riverheadMarker.addEventListener('markerFound', () => {
          if (markersDisabled) return;
          // Show photo overlay
          const overlay = document.getElementById('riverheadOverlay');
          overlay.style.display = 'block';

          // Create Title and Description if not already present
          if (!titleElement && !descriptionElement) {
            titleElement = document.createElement('p');
            titleElement.className = 'Title';
            titleElement.textContent = 'Riverhead';
            document.body.appendChild(titleElement);

            descriptionElement = document.createElement('p');
            descriptionElement.className = 'Description';
            descriptionElement.textContent = 'A view of the Riverhead landscape.';
            document.body.appendChild(descriptionElement);
          }

          // (No token overlay for Riverhead)
        });

        riverheadMarker.addEventListener('markerLost', () => {
          const overlay = document.getElementById('riverheadOverlay');
          overlay.style.display = 'none';
          // remove title/description
          if (titleElement && descriptionElement) {
            titleElement.remove();
            descriptionElement.remove();
            titleElement = null;
            descriptionElement = null;
          }
          // nothing to clear (no token timers)
        });

  const bullringMarker = document.querySelector('#BullRingM');
        bullringMarker.addEventListener('markerFound', () => {
          if (markersDisabled) return;
          const overlay = document.getElementById('bullringOverlay');
          overlay.style.display = 'block';

          if (!titleElement && !descriptionElement) {
            titleElement = document.createElement('p');
            titleElement.className = 'Title';
            titleElement.textContent = 'Bull Ring';
            document.body.appendChild(titleElement);

            descriptionElement = document.createElement('p');
            descriptionElement.className = 'Description';
            descriptionElement.textContent = 'A historic bull ring site.';
            document.body.appendChild(descriptionElement);
          }

          // (No token overlay for Bull Ring)
        });

        bullringMarker.addEventListener('markerLost', () => {
          const overlay = document.getElementById('bullringOverlay');
          overlay.style.display = 'none';
          if (titleElement && descriptionElement) {
            titleElement.remove();
            descriptionElement.remove();
            titleElement = null;
            descriptionElement = null;
          }
          // nothing to clear (no token timers)
        });

        // Special setup for LongshipText with one-time video play
        let longshipTextVideoPlayed = false;
        const longshipTextMarker = document.querySelector('#LongshipTextM');
        const longshipTextVideo = document.querySelector('#longshipTextVideo');

        longshipTextMarker.addEventListener('markerFound', () => {
          if (markersDisabled) return;
          if (!longshipTextVideoPlayed) {
            // Stop current playing video if any
            if (currentPlayingVideo) {
              currentPlayingVideo.pause();
            }

            longshipTextVideo.play();
            currentPlayingVideo = longshipTextVideo;
            videoStates['longshipTextVideo'].played = true;
          }
        });

        longshipTextVideo.addEventListener('ended', () => {
          videoStates['longshipTextVideo'].completed = true;
        });

        // Diagnostic: verify marker .patt files are reachable (logs 200/404)
        document.addEventListener('DOMContentLoaded', () => {
          const markers = document.querySelectorAll('a-marker');
          markers.forEach(marker => {
            const url = marker.getAttribute('url');
            if (!url) return;
            // Try fetching the pattern file to check availability
            fetch(url, { method: 'GET' })
              .then(resp => {
                if (!resp.ok) {
                  console.warn(`Marker pattern not reachable for #${marker.id}: ${url} (status ${resp.status})`);
                } else {
                  console.log(`Marker pattern OK for #${marker.id}: ${url} (status ${resp.status})`);
                }
              })
              .catch(err => {
                console.error(`Error fetching marker pattern for #${marker.id}: ${url}`, err);
              });
          });
        });
      </script>

</body>

</html>